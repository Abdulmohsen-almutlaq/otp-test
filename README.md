# Enterprise OTP Service

Production-ready TOTP (Time-based One-Time Password) authentication service optimized for Render.com deployment.

## Features

### üîê Security
- HMAC-SHA256 key derivation
- TOTP (RFC 6238) implementation
- API key authentication
- Rate limiting protection
- Audit logging for all operations
- Secure environment variable configuration

### üöÄ Production Ready
- FastAPI with automatic OpenAPI docs
- PostgreSQL database integration
- Structured JSON logging
- Health check endpoints
- Error handling and monitoring
- Docker containerization

### üìä Enterprise Features
- Device management and registration
- User audit trails
- Device deactivation
- Usage statistics
- IP address logging
- Configurable OTP parameters

## Quick Deploy to Render.com

### 1. Prerequisites
- Render.com account
- GitHub repository with this code

### 2. Deploy Steps

1. **Create New Web Service on Render**
   - Connect your GitHub repository
   - Choose "Web Service"
   - Runtime: Docker

2. **Environment Variables** (Add in Render dashboard)
   ```
   DATABASE_URL=<auto-generated by Render PostgreSQL>
   MASTER_SECRET=<generate 32+ character secret>
   API_KEY=<generate API key for client authentication>
   ENVIRONMENT=production
   DEBUG=false
   ```

3. **Add PostgreSQL Database**
   - In Render dashboard, create PostgreSQL database
   - Link to your web service (DATABASE_URL auto-configured)

4. **Deploy**
   - Render will automatically build and deploy
   - Access health check: `https://your-service.onrender.com/health`

## API Endpoints

### Health Check
```http
GET /health
```

### Register Device
```http
POST /api/v1/devices/register
Authorization: Bearer YOUR_API_KEY
Content-Type: application/json

{
    "device_id": "DEVICE-123",
    "user_id": "user@example.com"
}
```

**Response:**
```json
{
    "success": true,
    "message": "Device registered successfully",
    "data": {
        "device_id": "DEVICE-123",
        "derived_key": "base64-encoded-key"
    }
}
```

### Verify OTP
```http
POST /api/v1/otp/verify
Authorization: Bearer YOUR_API_KEY
Content-Type: application/json

{
    "device_id": "DEVICE-123",
    "otp": 123456
}
```

**Response:**
```json
{
    "success": true,
    "message": "OTP verification completed",
    "data": {
        "valid": true
    }
}
```

### Deactivate Device
```http
POST /api/v1/devices/{device_id}/deactivate
Authorization: Bearer YOUR_API_KEY
```

## Client Integration

### Python Client Example
```python
import requests
import hmac
import hashlib
import struct
import time
import base64

class OTPClient:
    def __init__(self, derived_key_b64):
        self.derived_key = base64.b64decode(derived_key_b64)
    
    def generate_otp(self, digits=6, interval=30):
        time_step = int(time.time() // interval)
        msg = struct.pack(">Q", time_step)
        hmac_hash = hmac.new(self.derived_key, msg, hashlib.sha1).digest()
        offset = hmac_hash[-1] & 0x0F
        truncated_hash = hmac_hash[offset:offset + 4]
        code_int = struct.unpack(">I", truncated_hash)[0] & 0x7FFFFFFF
        return code_int % (10 ** digits)

# Usage
client = OTPClient("your-derived-key-from-registration")
otp = client.generate_otp()
print(f"Current OTP: {otp}")
```

### Verify OTP with API
```python
import requests

def verify_otp(device_id, otp, api_key, base_url):
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    
    data = {
        "device_id": device_id,
        "otp": otp
    }
    
    response = requests.post(
        f"{base_url}/api/v1/otp/verify",
        json=data,
        headers=headers
    )
    
    return response.json()

# Usage
result = verify_otp("DEVICE-123", 123456, "your-api-key", "https://your-service.onrender.com")
print(f"Valid: {result['data']['valid']}")
```

## Database Schema

### Devices Table
- `device_id` (Primary Key)
- `user_id` 
- `derived_key_hash` (SHA256 hash for verification)
- `is_active`
- `created_at`
- `last_used`
- `usage_count`
- `deactivated_at`

### Audit Logs Table
- `id` (Auto-increment)
- `device_id`
- `action` (DEVICE_REGISTERED, OTP_VERIFICATION, etc.)
- `success`
- `timestamp`
- `ip_address`
- `user_agent`
- `additional_data`

## Security Best Practices

1. **Environment Variables**: Never hardcode secrets
2. **API Keys**: Generate strong, unique API keys
3. **HTTPS**: Always use HTTPS in production
4. **Rate Limiting**: Implement at application and infrastructure level
5. **Monitoring**: Set up alerts for failed authentications
6. **Key Rotation**: Plan for periodic master secret rotation
7. **Audit Logs**: Monitor and retain for compliance

## Monitoring & Maintenance

### Health Checks
- `/health` endpoint for uptime monitoring
- Database connectivity verification
- Application status reporting

### Logging
- Structured JSON logs
- Request/response tracking
- Security event logging
- Performance metrics

### Metrics (Future Enhancement)
- OTP verification success/failure rates
- Device registration trends
- API response times
- Database performance

## Scaling Considerations

### Horizontal Scaling
- Stateless application design
- Database connection pooling
- Load balancer compatible

### Performance Optimization
- Database indexing on frequently queried fields
- Redis caching for rate limiting
- Connection pooling
- Async database operations

## Troubleshooting

### Common Issues
1. **Clock Drift**: Increase `OTP_WINDOW` setting
2. **Rate Limiting**: Check audit logs for excessive requests
3. **Database Connection**: Verify `DATABASE_URL` configuration
4. **Authentication**: Ensure API key is correctly set

### Debug Mode
Set `DEBUG=true` for:
- API documentation at `/docs`
- Test endpoints
- Detailed error messages

## Cost Optimization for Render.com

1. **Database**: Use PostgreSQL starter plan ($7/month)
2. **Web Service**: Start with basic plan ($7/month)
3. **Monitoring**: Use Render's built-in metrics
4. **Scaling**: Monitor usage and scale as needed

## License

MIT License - See LICENSE file for details.

## Support

For issues and questions:
1. Check health endpoint: `/health`
2. Review application logs in Render dashboard
3. Verify environment variables
4. Check database connectivity
